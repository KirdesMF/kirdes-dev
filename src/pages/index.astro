---
import Header from "../components/Header.astro";
import SkillsGrid from "../components/SkillsGrid.astro";
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <Header />

  <main>
    <section class="min-h-dvh max-w-[1200px] mx-auto py-44 px-20" id="home">
      <div
        id="home-frame"
        class="w-full h-[550px] border border-dashed relative bg-background grid place-items-center @container"
      >
        <canvas id="splash-wave-canvas" class="size-full absolute inset-0"></canvas>
        <div class="relative grid place-items-center pointer-events-none">
          <div
            data-parallax-shadow
            class="absolute top-1/2 left-1/2 size-[23cqi] -translate-x-1/2 -translate-y-1/2 rounded-full bg-foreground blur-xs z-0 dark:hidden"
          >
          </div>
          <div
            data-parallax-circle
            class="size-[20cqi] rounded-full bg-background z-0 shadow-2xl relative grid place-items-center text-foreground"
          >
            <svg
              data-parallax-ring
              viewBox="0 0 200 200"
              class="absolute inset-0 size-full overflow-visible"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-dasharray="5 5"
              preserveAspectRatio="none"
            >
              <circle cx="100" cy="100" r="100"></circle>
            </svg>
          </div>
        </div>
        <div class="absolute top-0 start-0 size-2 bg-foreground -translate-1/2"></div>
        <div class="absolute top-0 end-0 size-2 bg-foreground -translate-y-1/2 translate-x-1/2"></div>
        <div class="absolute bottom-0 end-0 size-2 bg-foreground translate-y-1/2 translate-x-1/2"></div>
        <div class="absolute bottom-0 start-0 size-2 bg-foreground translate-y-1/2 -translate-x-1/2"></div>
      </div>
    </section>

    <section class="grid place-items-center">
      <SkillsGrid />
    </section>

    <section class="sticky top-0 min-h-dvh grid place-items-center">
      <div class="w-3/4 h-2/3 border border-dashed relative bg-background">
        <div class="absolute top-0 start-0 size-2 bg-foreground -translate-1/2"></div>
        <div class="absolute top-0 end-0 size-2 bg-foreground -translate-y-1/2 translate-x-1/2"></div>
        <div class="absolute bottom-0 end-0 size-2 bg-foreground translate-y-1/2 translate-x-1/2"></div>
        <div class="absolute bottom-0 start-0 size-2 bg-foreground translate-y-1/2 -translate-x-1/2"></div>

        <div class="relative size-full">
          <canvas id="moire-canvas" class="size-full absolute inset-0 pointer-events-none hidden"></canvas>
          <canvas id="repel-canvas" class="size-full absolute inset-0 pointer-events-none hidden"></canvas>
          <canvas id="wave-canvas" class="size-full border-0 block absolute inset-0"></canvas>
        </div>
      </div>
    </section>

    <section class="min-h-[200dvh] grid place-items-center" id="projects" data-wave-text="PROJECTS"></section>
    <section class="min-h-[200dvh] grid place-items-center" id="projects" data-wave-text="SKILLS"></section>
    <section class="min-h-[200dvh] grid place-items-center" id="about" data-wave-text="ABOUT"></section>

    <footer class="min-h-dvh grid place-items-center z-10 relative bg-background" id="contact">
      <h2 class="font-body text-9xl tracking-tighter">Contact</h2>
    </footer>
  </main>
</Layout>

<script>
  import { SplashWaveScene } from "../lib/canvas-2d/splash-wave";
  import { MoireCanvas } from "../lib/lines-repel/moire";
  import { LinesRepelScene } from "../lib/lines-repel/lines-repel-scene";
  import { WaveScene } from "../lib/wave/wave-scene";
  import { setupWaveSectionController } from "../lib/wave/wave-scroll-controller";
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const canvas = document.getElementById("splash-wave-canvas") as HTMLCanvasElement;
  const splash = new SplashWaveScene(canvas);
  splash.mount();

  const waveCanvas = document.getElementById("wave-canvas") as HTMLCanvasElement;
  const scene = new WaveScene({ canvas: waveCanvas });
  scene.start();

  const teardownWaveSections = setupWaveSectionController({
    scene,
    canvas: waveCanvas,
  });

  const moireCanvas = document.getElementById("moire-canvas") as HTMLCanvasElement;
  const moire = new MoireCanvas(moireCanvas, { lineSpacing: 30 });
  moire.start();

  const repelCanvas = document.getElementById("repel-canvas") as HTMLCanvasElement;
  const repel = new LinesRepelScene(repelCanvas, { configLines: { spacing: 30 } });
  repel.start();

  const homeFrame = document.getElementById("home-frame");
  const parallaxCircle = homeFrame?.querySelector("[data-parallax-circle]");
  const parallaxShadow = homeFrame?.querySelector("[data-parallax-shadow]");
  const parallaxRing = parallaxCircle?.querySelector("[data-parallax-ring]");

  if (homeFrame) {
    const maxOffset = 30;
    const shadowOffsetMultiplier = 1.8;
    const shadowScaleFactor = 0.25;
    const ringRotationMultiplier = 0.4;

    if (parallaxShadow) {
      gsap.set(parallaxShadow, { opacity: 0.35 });
    }
    if (parallaxRing) {
      gsap.set(parallaxRing, { rotation: 0, transformOrigin: "50% 50%" });
    }

    homeFrame.addEventListener("mousemove", (event) => {
      const rect = homeFrame.getBoundingClientRect();
      const normalizedX = (event.clientX - rect.left) / rect.width - 0.5;
      const normalizedY = (event.clientY - rect.top) / rect.height - 0.5;
      const distance = Math.min(Math.hypot(normalizedX, normalizedY), 0.75);
      const angleDeg = Math.atan2(normalizedY, normalizedX) * (180 / Math.PI);

      if (parallaxCircle) {
        gsap.to(parallaxCircle, {
          x: -normalizedX * maxOffset,
          y: -normalizedY * maxOffset,
          duration: 0.6,
          ease: "power2.out",
        });
      }

      if (parallaxRing) {
        gsap.to(parallaxRing, {
          rotation: angleDeg * ringRotationMultiplier,
          duration: 0.6,
          ease: "power2.out",
        });
      }

      if (parallaxShadow) {
        gsap.to(parallaxShadow, {
          x: -normalizedX * maxOffset * shadowOffsetMultiplier,
          y: -normalizedY * maxOffset * shadowOffsetMultiplier,
          scale: 1 + distance * shadowScaleFactor,
          opacity: 0.35 + distance * 0.25,
          duration: 0.6,
          ease: "power2.out",
        });
      }
    });

    homeFrame.addEventListener("mouseleave", () => {
      if (parallaxCircle) {
        gsap.to(parallaxCircle, { x: 0, y: 0, duration: 0.8, ease: "power2.out" });
      }

      if (parallaxRing) {
        gsap.to(parallaxRing, { rotation: 0, duration: 0.8, ease: "power2.out" });
      }

      if (parallaxShadow) {
        gsap.to(parallaxShadow, {
          x: 0,
          y: 0,
          scale: 1,
          opacity: 0.35,
          duration: 0.8,
          ease: "power2.out",
        });
      }
    });
  }

  window.addEventListener("beforeunload", () => {
    teardownWaveSections?.();
    splash.unmount();
    moire.dispose();
    scene.dispose();
  });

  gsap.ticker.add(() => {
    const { x, y, radius } = scene.getLensCSS();
    repel.setRepellerPosition({ x, y }, radius);
  });
</script>
