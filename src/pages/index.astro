---
import GridBox from "../components/GridBox.astro";
import GridContainer from "../components/GridContainer.astro";
import HeroAnimation from "../components/hero-animation/HeroAnimation.astro";
import Menu from "../components/Menu.astro";
import ScrabbleText from "../components/ScrabbleText.astro";
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <div class="fixed inset-0 grid grid-cols-8 container mx-auto size-full -z-10">
    <div class="border-s"></div>
    <div class="border-s"></div>
    <div class="border-s"></div>
    <div class="border-s"></div>
    <div class="border-s"></div>
    <div class="border-s"></div>
    <div class="border-s"></div>
    <div class="border-s border-e"></div>
  </div>

  <Menu orientation="vertical" />

  <GridContainer as="header" class="pt-52">
    <GridBox squares="all" class="col-span-7 striped ring" />

    <GridBox squares={["te"]} class="col-span-1 ring flex">
      <button data-theme-toggle class="text-xs font-light uppercase leading-none size-full ring py-4">Theme</button>
      <button data-menu-toggle class="text-xs font-light uppercase leading-none size-full ring py-4">Menu</button>
    </GridBox>
  </GridContainer>

  <main>
    <GridContainer>
      <GridBox squares="all" class="col-span-full py-32 px-16 grid place-items-center gap-2 ring">
        <small class="text-xl">Fast by design</small>
        <p class="text-3xl font-extralight max-w-[45ch] text-center">
          Accessible, performance-minded frontends with pragmatic services behind the scenes.
        </p>
      </GridBox>
    </GridContainer>

    <GridContainer>
      <GridBox squares="all" class="col-span-full ring h-[600px]">
        <HeroAnimation />
      </GridBox>
    </GridContainer>

    <GridContainer as="section" id="home">
      <GridBox squares="all" class="col-span-full h-[50svh] striped ring @container grid place-items-center">
        <canvas id="splash-wave-canvas" class="size-full absolute inset-0"></canvas>
        <div class="size-[18cqi] relative grid place-items-center text-foreground pointer-events-none">
          <div class="size-full bg-background border absolute inset-0 rounded-full"></div>
        </div>
      </GridBox>

      <GridBox class="col-span-2 ring py-4 grid place-items-center" squares={["ts", "te"]}>
        <p class="uppercase text-xs">copyright 2025</p>
      </GridBox>
      <GridBox class="col-span-6 striped ring" squares="all" />
    </GridContainer>

    <GridContainer>
      <GridBox class="col-span-6 bg-background ring grid place-items-center gap-12 p-12" squares="all">
        <ScrabbleText word="MAKE" />
        <ScrabbleText word="IT" />
        <ScrabbleText word="REAL" />
      </GridBox>
    </GridContainer>

    <GridContainer>
      <GridBox squares="all" class="striped ring bg-background col-span-full h-12" />
    </GridContainer>

    <GridContainer as="section" id="projects" class="sticky min-h-dvh top-0 items-center" data-wave-text="WORKS">
      <GridBox squares="all" class="ring bg-background h-[600px] col-span-full">
        <canvas id="moire-canvas" class="size-full absolute inset-0 pointer-events-none"></canvas>
        <canvas id="repel-canvas" class="size-full absolute inset-0 pointer-events-none"></canvas>
        <canvas id="wave-canvas" class="size-full block absolute inset-0"></canvas>
      </GridBox>
    </GridContainer>

    <section id="about" class="min-h-[200dvh] grid place-items-center" data-wave-text="ABOUT"></section>
    <section id="contact" class="min-h-dvh grid place-items-center" data-wave-text="CONTACT"></section>
  </main>
</Layout>

<script>
  import { SplashWaveScene } from "../lib/canvas-2d/splash-wave";
  import { MoireCanvas } from "../lib/lines-repel/moire";
  import { LinesRepelScene } from "../lib/lines-repel/lines-repel-scene";
  import { WaveScene } from "../lib/wave/wave-scene";
  import { setupWaveSectionController } from "../lib/wave/wave-scroll-controller";
  import { MENU_STATE_EVENT, dispatchMenuRequest } from "../lib/menu";
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  //------------ header
  const themeToggleBtn = document.querySelector<HTMLButtonElement>("[data-theme-toggle]");
  const menuToggleBtn = document.querySelector<HTMLButtonElement>("[data-menu-toggle]");
  const menuElement = document.querySelector<HTMLElement>("[data-menu]");
  const menuOpenClass = "menu-open";
  let isMenuOpen = false;

  themeToggleBtn?.addEventListener("click", () => {
    document.documentElement.classList.toggle("dark");
    const isDark = document.documentElement.classList.contains("dark");
    window.dispatchEvent(new CustomEvent("themechange", { detail: { theme: isDark ? "dark" : "light" } }));
  });

  menuElement?.setAttribute("inert", "true");

  menuToggleBtn?.addEventListener("click", () => {
    dispatchMenuRequest(!isMenuOpen);
  });

  window.addEventListener(MENU_STATE_EVENT, (event: Event) => {
    const detail = (event as CustomEvent<{ open: boolean }>).detail;
    if (!detail) return;
    isMenuOpen = detail.open;
    if (detail.open) {
      document.documentElement.classList.add(menuOpenClass);
      menuElement?.removeAttribute("inert");
    } else {
      document.documentElement.classList.remove(menuOpenClass);
      menuElement?.setAttribute("inert", "true");
    }
  });

  //------------ splash canvas
  const canvas = document.getElementById("splash-wave-canvas") as HTMLCanvasElement;
  const splash = new SplashWaveScene(canvas);
  splash.mount();

  //------------ section canvas
  const waveCanvas = document.getElementById("wave-canvas") as HTMLCanvasElement;
  const scene = new WaveScene({ canvas: waveCanvas });
  scene.start();

  const teardownWaveSections = setupWaveSectionController({
    scene,
    canvas: waveCanvas,
  });

  const moireCanvas = document.getElementById("moire-canvas") as HTMLCanvasElement;
  const moire = new MoireCanvas(moireCanvas, { lineSpacing: 30 });
  moire.start();

  const repelCanvas = document.getElementById("repel-canvas") as HTMLCanvasElement;
  const repel = new LinesRepelScene(repelCanvas, { configLines: { spacing: 30 } });
  repel.start();

  gsap.ticker.add(() => {
    const { x, y, radius } = scene.getLensCSS();
    repel.setRepellerPosition({ x, y }, radius);
  });

  //---------- clean
  window.addEventListener("beforeunload", () => {
    teardownWaveSections?.();
    splash.unmount();
    moire.dispose();
    scene.dispose();
  });
</script>
