---
type Props = {
	class?: string;
};
const segments = [
	{ id: 1, start: 0, end: 25, extra: "border-s border-y" },
	{ id: 2, start: 25, end: 50, extra: "border-y" },
	{ id: 3, start: 50, end: 75, extra: "border-y" },
	{ id: 4, start: 75, end: 100, extra: "border-y border-e" },
];

const { class: className } = Astro.props;
---

<button data-btn-split class:list={["bg-foreground relative size-full cursor-pointer transition-transform", className]}>
  {
    segments.map(({ id, start, end, extra }) => (
      <span
        data-btn-split-part={id}
        class={`will-change-transform size-full grid place-items-center absolute inset-0 bg-background ${extra}`}
        style={`clip-path: polygon(${start}% 0%, ${end}% 0%, ${end}% 100%, ${start}% 100%)`}
      >
        <slot />
      </span>
    ))
  }
</button>

<script>
  import { gsap } from "gsap";

  function initButton(btnSplit: HTMLButtonElement) {
    const btnSplitParts = Array.from(btnSplit.querySelectorAll("[data-btn-split-part]"));

    const BASE_OFFSET = { x: 10, y: -10 };
    const POINTER_FACTOR = 0.25;

    function moveParts(x: number, y: number, opts = {}, elements = btnSplitParts) {
      gsap.to(elements, {
        x,
        y,
        duration: 0.55,
        stagger: 0.05,
        ease: "elastic.out(1, 0.6)",
        overwrite: "auto",
        ...opts,
      });
    }

    function resetParts() {
      moveParts(0, 0);
    }

    let isTrackingPointer = false;

    function trackPointer(event: MouseEvent) {
      if (!isTrackingPointer) return;
      const rect = btnSplit.getBoundingClientRect();
      const relativeX = event.clientX - (rect.left + rect.width / 2);
      const relativeY = event.clientY - (rect.top + rect.height / 2);

      moveParts(BASE_OFFSET.x + relativeX * POINTER_FACTOR, BASE_OFFSET.y + relativeY * POINTER_FACTOR);
    }

    btnSplit.addEventListener("mouseenter", (event) => {
      isTrackingPointer = false;
      const rect = btnSplit.getBoundingClientRect();
      const isFromLeft = event.clientX <= rect.left + rect.width / 2;
      const elements = isFromLeft ? btnSplitParts : [...btnSplitParts].reverse();

      moveParts(
        BASE_OFFSET.x,
        BASE_OFFSET.y,
        {
          onComplete: () => {
            isTrackingPointer = true;
          },
        },
        elements,
      );
    });

    btnSplit.addEventListener("mousemove", trackPointer);
    btnSplit.addEventListener("mouseleave", () => {
      isTrackingPointer = false;
      resetParts();
    });
  }

  // Initialise tous les boutons avec data-btn-split
  document.querySelectorAll("[data-btn-split]").forEach((btn) => {
    initButton(btn as HTMLButtonElement);
  });
</script>
