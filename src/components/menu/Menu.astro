---
import { getLangFromURL, useTranslations } from "../../i18n/utils";
import LanguagePicker from "../LanguagePicker.astro";
import LightDarkMode from "../LightDarkMode.astro";

const lang = getLangFromURL(Astro.url);
const t = useTranslations(lang);
---

<div data-menu-overlay class="fixed inset-0 z-40 bg-background/80 opacity-0 pointer-events-none">
  <div data-menu-panel class="absolute end-12 top-24 w-[320px] max-w-full bg-background border border-foreground">
    <div class="grid gap-2 py-4 px-6">
      <nav>
        <ul class="flex gap-6 items-center">
          <li><a href={`/${lang}/`}>{t("nav.home")}</a></li>
          <li><a href={`/${lang}/blog`}>{t("nav.blog")}</a></li>
          <li><a href={`/${lang}/snippets`}>{t("nav.snippets")}</a></li>
          <li><a href={`/${lang}/gallery`}>{t("nav.gallery")}</a></li>
        </ul>
      </nav>

      <div class="flex justify-end items-center gap-4">
        <LightDarkMode />
        <span class="text-sm">|</span>
        <LanguagePicker />
      </div>
    </div>
  </div>
</div>

<script>
  import { gsap } from "gsap";
  import { onMenuToggle, emitMenuClose } from "./menu-events";

  function setupMenuOverlay() {
    const overlay = document.querySelector<HTMLDivElement>("[data-menu-overlay]");
    const panel = document.querySelector<HTMLDivElement>("[data-menu-panel]");

    if (!overlay || !panel) throw new Error("Menu elements not found");

    // Timeline d’entrée / sortie, pausée par défaut.
    const tl = gsap.timeline({
      paused: true,
      defaults: { duration: 0.4, ease: "power2.out" },
      onReverseComplete() {
        // quand le menu est complètement fermé, on coupe les interactions
        overlay.style.pointerEvents = "none";
      },
      onStart() {
        // quand on commence l’ouverture, on autorise les interactions
        overlay.style.pointerEvents = "auto";
      },
    });

    // État initial (menu fermé)
    gsap.set(overlay, { opacity: 0 });
    gsap.set(panel, { y: -20, opacity: 0 });

    // Animation d’ouverture
    tl.to(overlay, { opacity: 1 }, 0);
    tl.to(
      panel,
      {
        y: 0,
        opacity: 1,
      },
      0,
    );

    // Écoute l’event custom
    const unsubscribe = onMenuToggle((open) => {
      if (open) {
        tl.play();
      } else {
        tl.reverse();
      }
    });

    // Fermer au clic sur le backdrop (hors panel)
    overlay.addEventListener("click", (event: MouseEvent) => {
      if (!panel.contains(event.target as Node)) {
        emitMenuClose();
      }
    });

    // Fermer via Escape
    const handleKeydown = (event: KeyboardEvent) => {
      if (event.key === "Escape") {
        emitMenuClose();
      }
    };
    window.addEventListener("keydown", handleKeydown);

    // Cleanup
    window.addEventListener("beforeunload", () => {
      unsubscribe();
      window.removeEventListener("keydown", handleKeydown);
      tl.kill();
    });
  }

  setupMenuOverlay();
</script>
